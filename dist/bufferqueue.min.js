!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.bufferqueue=e()}(this,function(){"use strict";class t{constructor(){this._q=[],this._keys={}}add(t,e=1/0){t in this._keys||(this._q.unshift({str:t,priorityScore:e}),this._keys[t]=1)}has(t){return t in this._keys}pop(){let t=null;return this._q.length&&(t=this._q.pop().str,delete this._keys[t]),t}isEmpty(){return!this._q.length}size(){return this._q.length}first(){return this._q.length?this._q[0].str:null}last(){return this._q.length?this._q[this._q.length-1].str:null}remove(t){let e=null,s=-1;for(let e=0;e<this._q.length;e++)if(this._q[e].str===t){s=e;break}return s>-1&&(e=this._q.splice(s,1)[0].str,delete this._keys[e]),e}reset(){this._q=[],this._keys={}}sortByPriorityScore(){this._q.sort(function(t,e){return e.priorityScore-t.priorityScore})}}class e{constructor(e=3){this._qs=Array.from({length:e},()=>new t),this._probabilityMap=new Array(e),this._makeProbabilityMap()}_makeProbabilityMap(){let t=this._qs.length,e=Array.from({length:t},(t,e)=>1/Math.pow(2,e)),s=e.reduce((t,e)=>t+e);for(let r=0;r<t;r++)this._probabilityMap[r]=e[r]/s,r>0&&(this._probabilityMap[r]+=this._probabilityMap[r-1])}getPriority(t){for(let e=0;e<this._qs.length;e++)if(this._qs[e].has(t))return e;return-1}has(t,e=-1){if(~e)return this._qs[e].has(t);for(let e=0;e<this._qs.length;e++)if(this._qs[e].has(t))return!0;return!1}add(t,e,s=1/0){let r=this.getPriority(t);return!(r>=e)&&(r>=0&&this.remove(t),this._qs[e].add(t,s),!0)}pop_ORIG(){for(let t=0;t<this._qs.length;t++)if(!this._qs[t].isEmpty())return this._qs[t].pop();return null}pop(){if(this.isEmpty())return null;let t=0;for(let e=0;e<this._qs.length;e++)if(this._qs[e].isEmpty())t=this._probabilityMap[e];else if(0!==t)break;let e=t+Math.random()*(1-t),s=0;for(let t=0;t<this._qs.length;t++)if(e<this._probabilityMap[t]){s=t;break}if(this._qs[s].isEmpty())for(let t=s;0==t;t--)if(!this._qs[t].isEmpty())return this._qs[t].pop();return this._qs[s].pop()}isEmpty(){return this._qs.every(t=>t.isEmpty())}size(t=-1){if(~t)return this._qs[t].size();let e=0;for(let t=0;t<this._qs.length;t++)e+=this._qs[t].size();return e}sizePerPriority(){return this._qs.map(t=>t.size())}remove(t){let e=null;for(let s=0;s<this._qs.length;s++)e=e||this._qs[s].remove(t);return e}reset(){for(let t=0;t<this._qs.length;t++)this._qs[t].reset()}getStatus(){let t="";for(let e=0;e<this._qs.length;e++)t+=`level ${e} >> ${this._qs[e].size()} elements\n`;return t}sortWithinLevel(){for(let t=0;t<this._qs.length;t++)this._qs[t].sortByPriorityScore()}}class s{constructor(){this._events={}}on(t,e){"function"==typeof e?(t in this._events||(this._events[t]=[]),this._events[t].push(e)):console.warn("The callback must be of type Function")}emit(t,e=[]){if(t in this._events&&this._events[t].length>0){const s=this._events[t];for(let t=0;t<s.length;t+=1)s[t](...e)}}}function r(t,e,s){return t&&e in t?t[e]:s}return{BufferQueue:class extends s{constructor(t){super(),this._concurentDownloads=r(t,"concurentDownloads",4),this._pq=new e(r(t,"priorityLevels",3)),this._httpSettings=r(t,"httpSettings",{}),this._dlControllers={};let s=this;setInterval(function(){s._tryNext()},200)}getPriority(t){return this._pq.getPriority(t)}has(t,e=-1){return this._pq.has(t,e)}add(t,e,s=1/0){this._pq.add(t,e,s)&&(this.emit("added",[t,e]),this._tryNext())}isEmpty(){return this._pq.isEmpty()}size(){return this._pq.size()}sizePerPriority(){return this._pq.sizePerPriority()}remove(t){this._pq.remove(t)&&this.emit("removed",[t])}reset(){this._pq.reset(),this._dlControllers={},this.emit("reseted",[])}abort(t){t in this._dlControllers&&this._dlControllers[t].abort()}abortAll(){let t=Object.keys(this._dlControllers);for(let e=0;e<t.length;e++)this._dlControllers[t[e]].abort()}_tryNext(){if(Object.keys(this._dlControllers).length>=this._concurentDownloads)return;let t=this._pq.pop();t&&this._startDownload(t)}_startDownload(t){let e=this,s=new Request(t,this._httpSettings);this._dlControllers[t]=s.signal,this.emit("downloading",[t]);let r=performance.now(),i=r;fetch(s).then(t=>t.ok?(i=performance.now(),t.blob()):(e.emit("failed",[url,t]),null)).then(s=>{if(delete e._dlControllers[t],!s)return;let n=new FileReader;n.onload=function(s){let n=s.target.result;e.emit("success",[t,n,i-r])},n.readAsArrayBuffer(s),e._tryNext()}).catch(function(s){delete e._dlControllers[t],e._tryNext(),20===s.code?e.emit("aborted",[t]):e.emit("failed",[t,s])})}getStatus(){return`${this._pq.getStatus()}Current downloads: ${Object.keys(this._dlControllers).length}`}sortWithinLevel(){this._pq.sortWithinLevel()}}}});
